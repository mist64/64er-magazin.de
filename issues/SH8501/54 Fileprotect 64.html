<!DOCTYPE html>
<html lang="de">

<head>
	<title>Fileprotect 64</title>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="../style.css">
	<meta name="author" content="Jochen Fette, rg">
	<meta name="64er.issue" content="Sonderheft 1/85">
	<meta name="64er.pages" content="54-62">
	<meta name="64er.head1" content="Fileprotect">
	<meta name="64er.head2" content="C 64">
	<meta name="64er.toc_title" content="Fileprotect (C 64)">
	<meta name="64er.toc_category" content="">
	<meta name="64er.id" content="fileprotect">
</head>

<body>
	<article>
		<h1>Fileprotect 64</h1>

		<p>Sicher kennen auch Sie das Problem: »OPEN1,8,15,"S:xyz*"« und schon ist es passiert! Wie leicht löscht man unbeabsichtigt ein Programm oder eine Datei von der Diskette.</p>

		<p>Das Programm Fileproject 64 sorgt dafür, daß Ihnen so etwas nicht mehr passieren kann. Mit ihm lassen sich alle Filetypen der Floppy 1541 vorm Scratchen schützen. Natürlich kann der Schutz auch wieder entfernt werden.</p>

		<p>Die Sprungadressen sind so angelegt, daß Sie beim Abtippen die REM-Zeichen nicht mit eingeben müssen.</p>

		<p>Nach dem Starten des Programms erscheint das Titelbild mit dem Menü (Bild 1), von dem aus Sie in drei Unterprogramme verzweigen, oder das Programm beenden können. Drücken Sie hier die »F8-Taste«, so erzeugen Sie einen System-Reset (SYS 64738). Haben Sie Fileprotect 64 noch nicht abgespeichert, müssen Sie es mit der »STOP-Taste« beenden, sonst war die Arbeit des Abtippens umsonst&hellip;</p>

		<p>Nehmen wir an, Sie wollen das Directory einer Diskette einlesen. Betätigen Sie dazu bitte die »F1-Taste«. Der Bildschirm wird gelöscht, es erscheint die Überschrift »DIRECTORY« und Sie werden aufgefordert eine Diskette einzulegen und eine Taste zu drücken. Sollten Sie versehentlich eine Taste drücken und es befindet sich noch keine Disk im Laufwerk, so wird die Fehlermeldung »DISK FEHLER« ausgegeben (Bild 2) und ein erneuter Tastendruck erwartet. Nach Auflisten der Einträge müssen Sie wieder eine Taste drücken (Bild 3), um zum Menü zurückzukehren. Hat das Directory mehr als 15 Einträge, so erscheint die Meldung »WEITERE EINTRAEGE BITTE TASTE DRUECKEN« und es wird eine neue Seite angelegt und angezeigt.</p>

		<p>Möchten Sie ein Programm schützen, betätigen Sie die »F3-Taste«. Jetztwerden Sie erneut aufgefordert, eine Diskette einzulegen und eine Taste zu drücken. Haben Sie dies getan, prüft Fileprotect 64, ob eine Disk eingelegt ist und ob sie mit einem Schreibschutz versehen ist! Ist dies der Fall, wird die Fehlermeldung »SCHREIBSCHUTZ ENTFERNEN« ausgegeben (Bild 4). Haben Sie eine korrekte Disk eingelegt, durchsucht das Programm die Directory nach ungeschützten Files; wurde ein solcher Eintrag gefunden, so wird dessen Filetyp und Name ausgegeben. Danach erscheint »PROTECT (J/N)« (Bild 5) und Sie können entscheiden, ob Sie das File schützen wollen oder ob nicht. Sind keine weiteren ungeschützten Files auf der Diskette, kehrt das Programm zum Menü zurück. Drücken Siejetzt die »Fl-Taste« und lesen das Directory ein, so erkennen Sie geschützte Files an dem &gt;-Zeichen hinter dem Filetyp. Wählen Sie erneut »Protect« an, werden Sie feststellen, daß die eben geschützten Files nicht mehr abgefragt werden! Möchten Sie den Scratchschutz wieder entfernen, wählen Sie »F5 UNPROTECT«. Alles weitere läuft dann so ab, wie Sie es von »Protect« kennen.</p>

		<p>Nun möchte ich noch einige Worte über die Funktionsweise von »Fileprotect 64« sagen.</p>

		<p>Das Betriebssystem der Floppy 1541 kennt, wie Sie sicher wissen, fünf verschiedene Filetypen. Diese können geöffnet, geschlossen oder geschützt sein. Somit sind dann 15 verschiedene Zustände möglich. Der Filetyp wird in der Directory durch das erste Byte eines Fileeintrages gekennzeichnet. Wie Sie in Tabelle 1 sehen, unterscheidet sich ein geschützter Filetyp von einem ungeschützten durch das gesetzte sechste Bit. Das Setzen des Bits erreicht man, indem man den ungeschützten Filetyp durch die »OR«-Funktion mit der Zahl 64 verknüpft. In Tabelle 2 sehen Sie an dem Beispiel »PRG«, wie die OR-Verknüpfung arbeitet. Die beiden Operanten werden Bitfür Bit verglichen. Ist in einem der Faktoren ein Bit gesetzt, also 1, wird es auch im Ergebnisbyte gesetzt. Um das sechste Bit wieder auf 0 zu setzen, wählen wir die Verknüpfung »AND«. Jetzt ergibt sich eine 1 im Ergebnisbyte nur dann, wenn beide Faktoren den Wert 1 haben. Diese Eigenschaft können wir nutzen, um eine bestimmte Bitstelle auf 0 zu setzen. Wir verknüpfen das geschützte Byte mit dem Faktor 191 (dual 1011 1111) und erhalten wieder den ungeschützten Filetyp 130 (Tabelle 3).</p>

		<p>Genug der grauen Theorie! Wie kann man diese Änderungen nun auf der Diskette vornehmen? Dazu müssen wir den Filetyp (1 Byte) von der Disk lesen, ihn ändern und dann wieder zurückschreiben. Das Betriebssystem der 1541 sieht hierzu die Befehle »U1« (Block lesen) und »U2« (Block schreiben) vor. Mit diesen Befehlen können Sie aber nur ganze Blöcke, also 256 Byte m den Puffer einer Direktzugriffsdatei einlesen oder aus ihm auf die Diskette schreiben. Da wir nur ein bestimmtes Byte benötigen nutzen wir die Möglichkeit, den Zeiger, der die augenblickliche Lese oder Schreibposition im Puffer angibt, auf einzelne Bytes setzen zu können. Der Befehl hierfür lautet »B-P« (Buffer Pointer). Alle Befehle, die für die Floppy bestimmt sind, werden über den Befehlskanal gesendet, der im »OPEN«-Befehl (Zeile 640) durch die Sekundäradresse 15 angesprochen wird. Mit dem PRINT #-Befehl werden jetzt die Kommandos übermittelt. Zum Beispiel lesen eines Sektors von Spur 18 (Zeile 2160). Daten können nicht direkt von der Diskette in den Computer eingelesen werden, sondern müssen in einem Datenpuffer zwischengespeichert werden. Dazu eröffnen wir eine Direktzugriffsdatei (Zeile 650), aus der wir dann mit dem GET #-Befehl die Bytes einzeln herauslesen.</p>

		<p>Im Bild 7 sehen Sie ein kleines Beispiel für die Anwendung der genannten Befehle. Mit diesem Unterprogramm können Sie den Namen einer Diskette einlesen.</p>

		<figure>
			<table>
				<tr>
					<td>Zeile</td>
					<td>Kommentar</td>
				</tr>
				<tr>
					<td>100-350</td>
					<td>Titel des HGMs, Adresse des Autors</td>
				</tr>
				<tr>
					<td>360-450</td>
					<td>Haupt-Programm, von hier aus werden die einzelnen Unterprogramme angesprungen. Aus welchen Zeilen die Unterprogramme angesprungen werden, entnehmen Sie bitte Tabelle 4.</td>
				</tr>
				<tr>
					<td>460-530</td>
					<td>Setzen der Bildschirmfarben und festlegen der Konstanten »BL$«</td>
				</tr>
				<tr>
					<td>540-600</td>
					<td>Unter-PGM warten auf Tastendruck und ein Zeichen aus dem Tastaturpuffer holen.</td>
				</tr>
				<tr>
					<td>610-660</td>
					<td>Unter-PGM: Befehlskanal und Direktzugriffsdatei auf der Floppy offnen</td>
				</tr>
				<tr>
					<td>670-730</td>
					<td>Unter-PGM. Zeichen aus Floppy-Puffer einlesen und sicherstellen, daß kein Leerstring weitergegeben wird.</td>
				</tr>
				<tr>
					<td>740-960</td>
					<td>Ausgabe des Titelbildes und Menüs</td>
				</tr>
				<tr>
					<td>970-1250</td>
					<td>In diesem Unterprogramm wird geprüft, ob eine Disk eingelegt ist oder ob bei Protect und Unprotect ein Schreibschutz auf der Disk vorhanden ist. Außerdem wird wenn kein Fehler auftrat, bei Protect und Unprotect eine Tabellenüberschrift ausgegeben</td>
				</tr>
				<tr>
					<td>1260-1430</td>
					<td>Unter-PGM Filetyp einlesen und auswerten</td>
				</tr>
				<tr>
					<td>1440-2040</td>
					<td>UnterPGM Directory einlesen.</td>
				</tr>
				<tr>
					<td>2050-2510</td>
					<td>Unter-PGM: Protect oderUnprotect. Ist im Haupt-PGM P = 1 dann wird die Routine Protect, ist P = 0 die Routine Unprotect durchgeführt</td>
				</tr>
			</table>
		</figure>

		<p>Die Funktionen der einzelnen Variablen entnehmen Sie bitte Tabelle 5. Eine wichtige Anmerkung: Damit Fileprotect 64 einwandfrei arbeitet, muß in Zeile 2499 hinter dem »(FT)« unbedingt ein Semikolon (;) gesetzt sein! Ist dies nicht der Fall, können Sie geschützte Programme nicht mehr laden. Ohne Semikolon wird ein CHR$(13) an den Wert angehängt. Es würden also zwei Byte und damit die Startadresse des Programms überschrieben!</p>

		<address class="author">(Jochen Fette / rg)</address>

		<aside class="fehlerteufelchen" id="fehlerteufelchen">
			<h2>Fehlerteufelchen</h2>
			<p>Die Zeilen 2470 und 2480 müssen, um einen Absturz in der Protect-Ebene zu vermeiden, folgendermaßen geändert werden:<br>
				2470 IFP=1THENFT=(FT{SPACE}OR{SPACE}64)<br>
				2480 IFP=0THENFT=(FT{SPACE}AND{SPACE}255-64)</p>
			<p>Wichtig ist dabei, daß die Zwischenräume {SPACE} eingegeben werden. Dieser fehlende Zwischenraum ist leider auch auf der Diskette vorhanden. Die Anwender dieser Diskette müssen also die Blanks in 2470 und 2480 nachträglich noch einfügen.</p>
			<address class="author">(Klaus Dieter Kupfermann)</address>
			<!-- 64'er 3/1985 -->
		</aside>

	</article>

</body>

</html>