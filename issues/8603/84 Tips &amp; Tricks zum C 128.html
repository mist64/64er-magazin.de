<!DOCTYPE html>
<html lang="de">

<head>
    <title>Tips &amp; Tricks zum C 128</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../style.css">
    <meta name="author" content="P. Guth, Marcus Heinze, ah, tr">
    <meta name="64er.issue" content="3/86">
    <meta name="64er.pages" content="84-85">
    <meta name="64er.head1" content="Tips&Tricks">
    <meta name="64er.head2" content="128er">
    <meta name="64er.toc_title" content="zum C 128">
    <meta name="64er.toc_category" content="Listings zum Abtippen|Tips und Tricks">
    <meta name="64er.index_title" content="Tips & Tricks zum C 128 (Ft.: 05/86 87)">
    <meta name="64er.index_category" content="Tips & Tricks C 128|Drucker Grafik">
    <meta name="64er.id" content="tips_c128">
</head>

<body>
    <article>
        <h1>Tips &amp; Tricks zum C 128</h1>
        <p class="intro">Beachtenswert ist diesmal ein vollwertiges Software-Interface zum Anschluß eines Centronics-Druckers an den C128. Der Kauf eines teuren Hardware-Interfaces erübrigt sich damit.</p>

        <p>Besitzen Sie einen Drucker mit parallelem Dateneingang und einen C 128? Und Sie sind der Meinung, daß sich diese beiden im C 128-Modus nicht kombinieren lassen? (Ohne den Kauf eines teuren Hardware-Interfaces natürlich.)</p>

        <p>Irrtum! Das Programm »Interface« lenkt sämtliche Druckerausgaben auf den User-Port, an dem es einen Centronics-Port simuliert. Sie benötigen lediglich noch zwei Stecker und ein paar Kabel.</p>

        <p>Am besten, Sie tippen das Programm (Listing 1) im C 64-Modus mit Hilfe des MSE ein. Im C 128-Modus laden Sie es dann absolut, das heißt mit »,8,1«.</p>

        <p>Nach der Initialisierung mit »SYS 5120« meldet sich das Interface mit seiner Einschaltmeldung. Man hat jetzt zwei Kanäle zur Verfügung:</p>

        <ul class="plain">
            <li>OPEN1,4: wandelt den Commodore-eigenen Code in Epson-kompatiblen Code um. (Zum Beispiel, um Sonderzeichen auszudrucken, oder Escape-Sequenzen zu senden.)</li>
            <li>OPEN1,5: gibt die Daten ungewandelt aus. (Um zum Beispiel den Drucker per Software umzuschalten.)</li>
        </ul>

        <p>Um die zusätzlichen Eigenheiten des Interfaces zu nutzen, ist das Steuer-Byte (Adresse 5126) interessant.</p>

        <p>Setzt man hier das Bit 2, so wird nach jedem Carriage Return ein Zeilenvorschub (Linefeed) ausgegeben (POKE 5126,4).</p>

        <p>Setzt man das Bit 3, so kann man das Interface durch Betätigen der Restore-Taste initialisieren (POKE 5126,8)</p>

        <p>Will man beide Funktionen aktivieren, so geschieht dies durch POKE 5126,12.</p>

        <p>Ausgeschaltet wird das Interface entweder mit »POKE 5126, PEEK(5126) AND 251« und anschließendem Drücken von RUN/STOP-RESTORE, <a href="#fehlerteufelchen" class="fehlerteufelchen_link">oder durch »SYS 5123«.</a></p>

        <p>Noch ein Wort zur Codewandlung: Ist die ASCII/DIN-Taste gedrückt, so liefern die Umlaute einen anderen Code. Das Interface berücksichtigt selbständig, ob diese Taste gedrückt ist oder nicht und schaltet gegebenenfalls eine zusätzliche Codewandlung ein.</p>

        <address class="author">(Marcus Heinze/tr)</address>

        <figure>
            <table class="plain center0 right2 center3">
                <tr class="strong"><td>User-Port-Pins</td><td colspan="2">Name</td><td>Centronics-Pins</td></tr>
                <tr><td>A</td><td colspan="2">GND (Masse)</td><td class="center">16</td></tr>
                <tr><td>B</td><td colspan="2">Busy-Flag Datenleitung</td><td class="center">11</td></tr>
                <tr><td>C</td><td>d0</td><td>Bit 0</td><td>2</td></tr>
                <tr><td>D</td><td>d1</td><td>Bit 1</td><td>3</td></tr>
                <tr><td>E</td><td>d2</td><td>Bit 2</td><td>4</td></tr>
                <tr><td>F</td><td>d3</td><td>Bit 3</td><td>5</td></tr>
                <tr><td>H</td><td>d4</td><td>Bit 4</td><td>6</td></tr>
                <tr><td>J</td><td>d5</td><td>Bit 5</td><td>7</td></tr>
                <tr><td>K</td><td>d6</td><td>Bit 6</td><td>8</td></tr>
                <tr><td>L</td><td>d7</td><td>Bit 7</td><td>9</td></tr>
                <tr><td>M</td><td colspan="2">PA2-Strobe</td><td class="center">1</td></tr>
            </table>
            <table class="plain">
                <tr><td class="strong">Stecker:</td><td>User-Port: TRW 251-12-50-170</td></tr>
                <tr><td></td><td>Drucker: Amphenol (36polig)</td></tr>
            </table>
            <table class="plain">
                <tr><td class="strong">Kabel:</td><td>Flach- oder Rundkabel, maximal 1,5 Meter Länge</td></tr>
            </table>
            <figcaption>Verkabelungsplan</figcaption>
        </figure>

        <h2>Flimmerproblem beim C 128 beseitigt</h2>

        <p>Einigen C 128-Besitzern, die das Programm »80-Zeichen-Grafik« aus der Ausgabe 12/85 abgetippt haben, wird das merkwürdige »kräuseln« am rechten Bildschirmrand unangenehm aufgefallen sein. Um diesen Fehler zu beseitigen, gehen Sie wie folgt vor:</p>

        <p>Nach dem Einschalten des Computers ist die Befehlsfolge
            <code>POKE 54874,25 : ? PEEK (54875)</code>
            einzugeben. Als Ergebnis gibt es nun zwei Möglichkeiten: Bei der ersten Version des C 128 erscheint eine »64« und bei der zweiten eine »71«. Erscheint die »71«, muß der Basic-Lader der 80-Zeichen-Grafik folgendermaßen geändert werden.</p>

        <p>In Zeile 14040 muß die »64« durch »71« und in Zeile 14080 die Zahl »128« durch »135« ersetzt werden. Besitzt jemand nur den Maschinensprache-Teil, so kann er das Programm durch die Befehle: POKE 6752,71: POKE 6789,135 anpassen. Die nötigen Änderungen für das Programm »Doppelte Grafikauflösung« aus der Ausgabe 11/85 sehen dann so aus: POKE 5150,135 : POKE 5158,71.</p>

        <p>Es existieren anscheinend zwei Versionen des VDC-8563-Chips. Überprüft man deren Statusanzeige, so kann man feststellen, welche der beiden Versionen vorliegt.</p>

        <p>Genau dies wird auch in der Initialisierungs-Routine für den VDC (ab $E179) gemacht. Hier wird die Adresse $D600 gelesen und die Bit 0 bis 2 getestet. Sind diese Bit alle gelöscht, so wird in das VDC-Register 25 eine 64 geschrieben, andernfalls kommt in das Register 25 eine 71.</p>

        <p>Will man die hochauflösende Grafik einschalten, so muß im Register 25 das Bit 7 gesetzt und das Bit 6 gelöscht werden. Verändert man hierbei die Bit 0 bis 3, so hat das ein Verschieben des Bildschirms nach links oder rechts zur Folge. Der VDC greift nun auf einen anderen Teil seines Video-RAMs zu, und es kommt somit im Grafik-Modus zu dem bekannten »Kräuseln«.</p>

        <address class="author">(P. Guth/ah)</address>

        <aside class="fehlerteufelchen" id="fehlerteufelchen">
            <h2>Fehlerteufelchen</h2>

            <p>Im vorletzten Absatz auf der linken Seite steht, daß sich das Interface durch Drücken der RUN/STOP-RESTORE-Taste oder durch den Befehl »SYS
5123« abschalten läßt. Das ist nur bedingt richtig, denn der richtige Befehl zum Abschalten des Interfaces lautet »BANK 0:SYS 5123«</p>

            <!-- 64'er 5/1986 -->
        </aside>
    </article>

    <figure>
        <pre data-filename="interface 5120.prg" data-name="Interface 5120" data-mse=mse1></pre>
        <figcaption>Listing 1. Das Maschinenprogramm »Interface 5120« geben Sie am besten im C 64-Modus mit dem MSE ein.</figcaption>
    </figure>
    <div class="binary_download" data-filename="interface 5120.prg" data-name="Interface 5120"></div>

    <figure>
        <pre>.opt p,oo
*=   $1400
print    = $ffd2
         jmp init	;einschalten des nterfaces = sys 5120
         jmp exit     ;ausschalten des nterfaces = sys 5123
steuer   .byte%00000000 ;
init     sei
         lda #$ff  	; i/o register
         sta $dd03 	; port b auf
         lda $dd02 	; ausgang setzen
         ora #$04  	;
         sta $dd02 	;
         lda #&lt;open  	 ;kanal fuer ausgabe
         sta $0320 	;auf interface
         lda #&gt;open 	;setzen
         sta $0321 	;(ckout vector)
         lda #&lt;output   ;output vector
         sta $0326 	;auf interface
         lda #&gt;output   ;setzen
         sta $0327 	;
         ldx #$00  	;systemmeldung
l00      lda text,x	;
         jsr print	;
         inx 	;
         cmp #$00 	;
         bne l00	;
         lda #&lt;nmistr   ;nmi vector
         sta $0318	;auf interface
         lda #&gt;nmistr   ;setzen
         sta $0319	;
         cli
         rts
nmistr   lda #%00001000
         and steuer
         beq l1
         cli
         jsr init
         jmp ($0a00)
l1       jmp $fa40 	;nmi routine kernal
open     jsr $f202	;sucht logische filenummer ( in x )
         beq opn	;gefunden -&gt; ausgabe setzen
         jmp $f682	; betriebssystemmeldung ausgeben
opn      jsr $f212	;flparam
         lda $ba  	;aktuelles geraet
         cmp #$04       ; =4 "?
         bne l02        ; nein
         jmp l05        ; ja , nummer des ausgabegeraetes setzen
l02      cmp #$05  ; =5 "?
         bne l03        ; nein
         jmp l05        ; ja , nummer des ausgabegeraetes setzen
l03      jmp $f156 	;nummer des ausgabegeraetes setzen
 ; verkuerztes ckout; mit ueberpruefung ob auf bildschirm, usw
l05      jmp $f169 	; nummer des ausgabegeraetes setzen
 ;
output   pha 	;akku retten
         lda $9a 	;aktuelle geraete nummer
         cmp #$04
         bne l06
         jmp prlell
l06      cmp #$05
         bne l09
         jmp druck
l09      pla
         jmp $ef79 	;print
prlell   pla
         jsr codew
         cmp #$0d
         beq l13
         jmp drucke
l13      lda #%00000100  ; auf zusaetzliches
         and steuer          ; line feed pruefen
         bne l15
         lda #$0d
         jmp l14
l15      lda #$0a
         jsr drucke
         lda #$0d
l14      jmp drucke
;
codew    cmp #29	;  cursor right
         bne cw
         lda #32        ; =space
cw       cmp #$80  	; groesser 127 "?
         bpl l16   	;
         cmp #65   	; kleiner "a"
         bmi l17   	;
         cmp #93   	;
         bpl l17   	; groesser"ue"
         clc
         adc #32   	; in kleinschrift wandeln
l17      jsr codew2
         rts
l16      cmp #193	; groesser gross "a"
         bmi l17
         cmp #222  	; s.o.
         bpl l17
         sec
         sbc #128
         jmp l17
codew2   pha 	;akku retten
         lda $d3 	; ascii/din
         and #%00010000   ;umgeschaltet "?
         bne wandel
gewandeltpla
         rts 	;nein;zurueck
 ;wandel pla  	;zurueck
wandel   pla        	;ja;wandeln
         cmp #187
         bmi lr 	; kleiner als 188
         cmp #191
         bpl lr 	; groesser als 190
         clc
         sbc #63
lr       pha
         jmp gewandelt
;
druck    pla
drucke   cmp #$22
         bne lp
         lda $11
         eor #$ff
         sta $11
         lda #$22
lp       sta $dd01	;akku auf bus legen
         lda $dd0d	;output bits loeschen
         lda $dd00	;strobe setzen
         and #$fb 	;
         sta $dd00	;
         ora #$04 	;und wieder
         sta $dd00	;loeschen
;
         lda #$10       ; auf
l07      bit $dd0d	; acknowledge
         beq l07        ; warten
         clc
         rts
exit     sei
         ldx #$f1
         lda #$4c
         stx $0320
         sta $0321
         ldx #$79
         lda #$ef
         stx $0326
         sta $0327
         cli
         rts
text     .byte18,14
         .asc "128 Centronics-Interface     Version 2.0"
         .byte146
         .byte$20
         .asc" ((c) by M.Heinze 17.11.1985 in Erlangen"
         .byte$0d
         .byte00</pre>
        <figcaption>Listing 2. Der dokumentierte Quellcode zum »Interface 5120«.</figcaption>
    </figure>
    <div class="binary_download" data-filename="interface source.prg" data-name="Interface 5120 Quellcode"></div>

</body>

</html>
