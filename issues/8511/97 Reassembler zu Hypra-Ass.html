<!DOCTYPE html>
<html lang="de">

<head>
    <title>Reassembler zu Hypra-Ass</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../style.css">
    <meta name="author" content="Martin Wehner, ah">
    <meta name="64er.issue" content="11/85">
    <meta name="64er.pages" content="97-98,100-101">
    <meta name="64er.head1" content="Tips und Tricks">
    <meta name="64er.head2" content="C 64">
    <meta name="64er.toc_title" content="<b>Schneller Reassembler zu Hypra-Ass</b>">
    <meta name="64er.toc_category" content="Tips und Tricks">
    <meta name="64er.index_title" content="Reassembler zu Hypra-Ass">
    <meta name="64er.index_category" content="Listings zum Abtippen|Anwendungen">
    <meta name="64er.id" content="reassembler">
</head>

<body>
    <article>
        <h1>Reassembler zu Hypra-Ass</h1>
        <p class="intro">Passend zum Assembler Hypra-Ass stellen wir Ihnen jetzt auch einen professionellen Reassembler vor, der aus einem Maschinenprogramm Quelltext erzeugt.</p>

        <p>Der Reassembler (siehe Listing) ist vollständig in Maschinensprache geschrieben. Er belegt den Speicherplatz von $C000 bis $CB00, kann aber mit dem SMON in jeden anderen Bereich verschoben werden. Neben dem eigentlichen Reassembler stehen noch einige Basic-Befehle zur Verfügung, mit denen zum Beispiel Einsprungpunkte im Quelltext durch ein Label markiert werden können. Es läßt sich auch vorherbestimmen, ob der Reassembler selbständig nach Tabellen suchen soll oder nicht. Weiterhin läßt sich der Aufbau des Quelltextes in einigen Punkten mitbestimmen. Alle dazu nötigen Informationen werden dem Reassembler in einem kleinen Basic-Informationsprogramm mitgeteilt. Es stehen dafür drei neue Basic-Befehle zu Verfügung:</p>

        <ul class="plain">
            <li><strong>←P adresse</strong>: Mit diesem Befehl lassen sich Einsprungpunkte im Quelltext durch ein Label markieren. So sind Adressen, die mit SYS angesprungen werden, im Quelltext leichter auffindbar.</li>
            <li><strong>←T adresse, adresse</strong>: Mit diesem Befehl teilen Sie dem Reassembler die Lage von Tabellen mit. Die erste Adresse zeigt auf das erste und die zweite Adresse auf das letzte Byte der Tabelle. Tabellen werden vom Reassembler nicht reassembliert, sondern erscheinen im Quelltext in Form eines Hex-Dumps (siehe Bild 1; Zeile 190 und Bild 2 Zeile 230 bis 310).</li>
            <li><strong>←E (byte)</strong>: Der »E«-Befehl startet den Reassembler und steht am Ende des Informationsprogramms. Es wird nun aus einem Maschinenprogramm ein Quelltext erzeugt, der im Basic-Speicher abgelegt und anschließend wie ein normales Basic-Programm gespeichert oder editiert und mit Hypra-Ass assembliert werden kann.
            </li>
        </ul>

        <figure>
            <pre>10   -.li 1,4,7
20   -;*******************************
30   -;*   Ausgabe eines Textes auf  *
40   -;*        dem Bildschirm       *
50   -;*******************************
60   -.ba $8000 ;Startadresse = $8000
70   -;
80   -.eq ausgabe = $ffd2 ;Dies ist ein externes Label
90   -;
100  -anfang    ldy #0         ;Schleifenzaehler auf 0 setzen
110  -loop      lda text,y     ;Zeichen holen
120  -          cmp #"#"       ;mit Endekennzeichen vergleichen
130  -          beq ende
140  -          jsr ausgabe    ;Zeichen ausgeben
150  -          iny            ;Schleifenzaehler + 1
160  -          bne loop
170  -ende      rts            ;Ende und zurueck ins BASIC
180  -;
190  -text      .tx "Dies ist ein Beispieltext#"</pre>
            <figcaption>Bild 1. Beispielprogramm zum Reassembler (Original Quelltext erstellt mit Hypra-Ass)</figcaption>
        </figure>
        <figure>
            <pre>100-      .eq elffd2=$ffd2
110-;
120-      .ba $8000
130-;
140-l8000 ldy #$00       ; "."
150-l8002 lda tl8010,y
160-      cmp #$23       ; "#"
170-      beq l800f
180-      jsr elffd2
190-      iny
200-      bne l8002
210-l800f rts
220-;
230-tl8010.by $c4,$49,$45,$53,$20,$49,$53,$54;"Dies ist"
240-;
250-      .by $20,$45,$49,$4e,$20,$c2,$45,$49;" ein Bei"
260-;
270-      .by $53,$50,$49,$45,$4c,$54,$45,$58;"spieltex"
280-;
290-      .by $54        ; "t"
300-;
310-tl8029.by $23        ; "#"</pre>
            <figcaption>Bild 2. Reassembler-Quelltext zum Beispielprogramm aus Bild 1</figcaption>
        </figure>

        <p>Der Aufbau des Quelltextes läßt sich geringfügig beeinflussen, indem hinter den »E«-Befehl eine Zahl zwischen 0 und 255 eingegeben wird. Bei dieser Zahl handelt es sich um ein sogenanntes Informations-Byte. Die einzelnen Bits dieses Informations-Bytes haben folgende Bedeutung:</p>

        <table class="plain center1 center2 center3 center4 center5 center6 center7 center8">
            <tr><td>Informations-Byte:</td><td>o</td><td>o</td><td>o</td><td>o</td><td>o</td><td>o</td><td>o</td><td>o</td></tr>
            <tr><td>Bit:</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr>
            <tr><td>Wertigkeit: </td><td>128</td><td>064</td><td>032</td><td>016</td><td>008</td><td>004</td><td>002</td><td>001</td></tr>
        </table>

        <p>Um zum Beispiel Bit 1 und Bit 6 auf 1 zu setzen, sind die Wertigkeiten der einzelnen Bits zu addieren. In diesem Fall 2 + 64 = 66</p>

        <ul class="plain">
            <li><strong>Bit 0 gesetzt</strong>: Alle Zeropage-Adressen (Adressen von $00 bis $FF) werden durch ein Label mit nur drei Buchstaben (normal fünf) markiert.</li>
            <li><strong>Bit 1 gesetzt</strong>: Nach den Befehlen RT8, RTI, BRK und JMP wird eine Kommentarzeile in den Quelltext eingefügt (Zeile 220 in Bild 2). Dadurch wird der Quelltext übersichtlicher.</li>
            <li><strong>Bit 2 gesetzt</strong>: Bei allen Befehlen mit unmittelbarer Adressierung (zum Beispiel LDA #$41) wird der Operand zusätzlich im ASCII-Formatausgegeben (LDY #$00 ;""." — Zeile 140 und 160 in Bild 2), vorausgesetzt, er liegt zwischen 32 und 96 oder zwischen 160 und 224. Für den Fall, daß er außerhalb dieses Zahlenbereichs liegt, wird nur ein Punkt ausgegeben.</li>
            <li><strong>Bit 3 gesetzt</strong>: Zwischen je zwei Tabellenzeilen wird eine Kommentarzeile eingefügt (Zeile 240, 260, 280, 300 in Bild 2). Dieses erhöht die Übersichtlichkeit.</li>
            <li><strong>Bit 4 gesetzt</strong>: Der ASCII-Ausdruck wird bei Tabellen unterdrückt.</li>
            <li><strong>Bit 5 gesetzt</strong>: Ist dieses Bit gesetzt, werden externe Label und Tabellenlabel speziell gekennzeichnet (Zeile 100 und 230 in Bild 2). Tabellen wird ein »T« vorangestellt (zum Beispiel TLC000) und externen Label (Label die außerhalb des zu reassemblierenden Bereichs liegen) ein »E« (zum Beispiel ELC000).</li>
            <li><strong>Bit 6 gesetzt</strong>: Ist das Bit 6 gesetzt, sucht der Reassembler selbständig nach Tabellen. Es wird kein Quelltext, sondern ein Basic-Informationsprogramm generiert, das die Start- und Endadressen aller gefundenen Tabellen enthält. Dieses kann mit LIST oder — wenn Hypra-Ass geladen wurde — mit /E geLISTet und geändert werden.</li>
            <li><strong>Bit 7 gesetzt</strong>: Der Reassembler reassembliert die Speicherinhalte, die sich unter dem ROM im RAM befinden. Dadurch ist es möglich, Programme zu reassemblieren, die sich unter dem Basic-Interpreteroder Betriebssystem befinden.</li>
        </ul>

        <p>Aus den drei neuen Basic-Befehlen setzt sich jedes Informationsprogramm zusammen. Es wird mit folgender Befehls-Sequenz im Direktmodus gestartet:
            <code>SYS 49152, anfadr, endadr+1:RUN</code>
        </p>

        <ul class="plain">
            <li>anfadr = Anfangsadresse des Maschinenprogramms, das reassembliert werden soll.</li>
            <li>endadr = Endadresse des Maschinenprogramms, das reassembliert werden soll.</li>
        </ul>

        <p>Um zum Beispiel den Reassembler durch sich selbst reassemblieren zu lassen, gehen Sie wie folgt vor:</p>

        <ol>
            <li>Reassembler laden mit LOAD"REASS",8,1</li>
            <li>NEW &lt;RETURN&gt; eingeben</li>
            <li>Folgendes Basic-Informationsprogramm eingeben:
                <code>20←P $C000 ;Kennzeichnet die Adresse $C000 durch ein Label
                    30←T $C813,$CAFF ;Definiert eine Tabelle im Bereich von $C813 bis $CAFF
                    40←E 15 ;Startet den Reassembler und setzt die Bits 0 bis 3
                </code>
            </li>
            <li>SYS49152,$C000,$CB00:RUN &lt;RETURN&gt; im Direktmodus eingeben.</li>
        </ol>


        <p>Die SYS-Zeile, mit der das Informationsprogramm gestartet wird, teilt dem Reassembler mit, daß das zu reassemblierende Maschinenprogramm im Bereich von $C000 bis $CAFF ($CB00 - 1) liegt. In Zeile 20 trifft der Reassembler auf den »P«-Befehl, der dazu auffordert, die Adresse $C000 durch ein Label zu markieren. Der »T«-Befehl in Zeile 30 definiert eine Tabelle im Bereich $C813 bis $CAFF und der »E«-Befehl in Zeile 40 startet schließlich den Reassembler.</p>

        <p>In weniger als 8 Sekunden wird nun ein etwa 17 KByte langer Quelltext erzeugt, der mit LIST oder — wenn Hypra-Ass geladen und gestartet wurde — mit dem /E-Befehl geLISTet und mit RUN assembliert werden kann.</p>

        <p>Wie Sie sicherlich schon bemerkt haben, verarbeitet der Reassembler nicht nur Dezimal-, sondern auch Hexadezimalzahlen. Eine Hexadezimalzahl beginnt mit einem Dollar-Zeichen ($), dem genau vier Hex-Ziffern folgen müssen. Beispiel: $0073, $C000, $FFFF</p>

        <h3>Besonderheiten</h3>

        <ol>
            <li>Der Reassembler arbeitet ausgezeichnet mit Hypra-Ass zusammen. Dabei ist es jedoch übersichtlicher, das Informationsprogramm ohne Leerzeichen einzugeben, weil Hypra-Ass nach dem ersten Leerzeichen einen Tabulator einfügt. Das Aussehen des Quelltextes würde dadurch verunstaltet. Gestartet wird das Informationsprogramm wie gewohnt mit RUN. (Vergessen Sie nicht den Minusstrich vor jeder Zeile, wenn Hypra-Ass geladen ist.)</li>
            <li>Aus programmtechnischen Gründen kann es vorkommen, daß der Reassembler im ersten Pass ein Maschinenprogramm anders reassembliert als im zweiten. Dadurch können in Pass 2 Sprungadressen im Maschinenprogramm auftauchen, die in Pass 1 nicht gefunden wurden und deshalb auch im Quelltext nicht durch ein Label markiert werden. Der Reassembler ersetzt in diesem Fall die Sprungadresse <strong>nicht</strong> durch ein Label, sondern stellt sie als Hex-Zahl im Quelltext dar. An die entsprechende Zeile werden 3 Fragezeichen angehängt.</li>
            <li>3-Byte-Befehle, die bei der Assemblierung als 2-Byte-Befehle interpretiert werden (BIT $A9 $00 = .BY $2C LDA #$00), werden nicht reassembliert. Statt dessen werden die 3 Byte mit vorangestelltem .BY-Pseudoopcode in den Quelltext eingefügt Der reassemblierte Befehl wird aber als Kommentar an die entsprechende Zeile angefügt.</li>
            <li>Es ist möglich, ein Programm so zu reassemblieren, als ob es in einem anderen Bereich läge. Dazu ist an den SYS-Befehl eine weitere Adresse anzuhängen:
                <code>SYS 49152, anfadr, endadr, get</code>
                <p>anfadr und endadr geben die Anfangs- und Endadresse des Bereichs an, in dem das Maschinenprogramm liegen soll, get gibt die Anfangsadresse des Bereichs an, in dem das Programm tatsächlich liegt.</p>
                    <p>So kann man zum Beispiel die Kopie der CHRGET-Routine ab $E3A2 reassemblieren, als ob sie im Bereich von $0073 bis $008A liegen würde. Dazu ist im Direktmodus folgende Zeile einzugeben:
                    <code>SYS 49152, $0073, $008A, $E3A2:←E</code>
                </p>
                <p>Da keine Tabellen in diesem Bereich liegen, kann auf ein Informationsprogramm verzichtet werden.</p>
            </li>
            <li>Es ist möglich, während der Reassemblierung den erzeugten Quelltext auf Diskette zu schreiben. Dadurch bleibt der Basic-Speicher für andere Programme frei. Dazu ist vor dem SYS-Befehl, mit dem die Start- und Endadresse übergeben wird, ein Programmfile zu öffnen. Mit dem Befehl CMD wird die Ausgabe auf das entsprechende Gerät umgeleitet. Das könnte wie folgt aussehen:
                <code>OPEN 1,8,1,"NAME,P,W":CMD 1:SYS 49152,$C000, $CB00:←E 64</code>
                <p>Mit dem OPEN-Befehl wird ein Programmfile mit dem Namen »Name« zum Schreiben geöffnet Der CMD-Befehl leitet die Ausgabe auf das Gerät mit der Gerätenummer 8 um (Disketten-Laufwerk). Der SYS-Befehl startet schließlich den Reassembler, dem durch den »E«-Befehl noch mitgeteilt wird, daß kein Quelltext, sondern ein Informationsprogramm erstellt werden soll. Das Informationsprogramm wird unter dem Namen »Name« auf Diskette gespeichert.</p>
                <p><strong>Vorsicht</strong>! Dieser Programmteil ist nicht gegen Fehlbedienung abgesichert. So führt eine nicht eingelegte Diskette zum Absturz des Systems. In einem solchen Fall ist ein RESET auszulösen. Hypra-Ass kann anschließend mit SYS 2168 neu gestartet werden. Außerdem sollte nach jedem Speichern die RUN/STOP-RESTORE-Taste gedrückt werden.</p>
            </li>
        </ol>

        <h3>Fehlermeldungen</h3>

        <ul class="plain">
            <li><strong>SYNTAX ERROR</strong>: Ein Basic-Befehl wurde falsch eingegeben oder eine Hex-Zahl besteht aus weniger als 4 Hex-Ziffern.</li>
            <li><strong>OUT 0F MEMORY</strong>: Es steht zu wenig Speicherplatz für den Quelltext zur Verfügung oder im Maschinenprogramm kommen mehr als 2700 verschiedene Label vor.</li>
            <li><strong>ILLEGAL QUANTITY</strong>: Vor einer Hex-Zahl fehlt das Dollar-Zeichen ($) oder das Tabellenende liegt vor dem Tabellenanfang oder die Tabellen überschneiden sich oder die angegebene Adresse liegt nicht im Maschinenprogramm.</li>
            <li><strong>TYPE MISMATCH</strong>: In einer Hex-Zahl stehen falsche Hex-Ziffern.</li>
        </ul>

        <p>Die Adresse, die schon als Einsprungpunkt markiert wurde, darf nicht als Tabellenanfang oder -ende angegeben werden. Im Informationsprogramm darf keine Adresse doppelt vorkommen.</p>

        <h3>Verschieben des Reassemblers</h3>

        <p>Der Reassembler benutzt in der Zeropage verschiedene Speicherzellen als Kurzzeitspeicher. Der Langzeitspeicher dagegen liegt unter dem Betriebssystem ($E000 bis $FFFF). Dort befindet sich auch ab Adresse $E028 die Label-Tabelle. In den Langzeitspeicher sollte nicht hineingePOKEt werden.</p>

        <p>Der Reassembler kann mit SMON ohne Schwierigkeiten im Speicher verschoben werden. Um den Reassembler nach $9000 zu verschieben, sind folgende SMON-Befehle einzugeben:
            <code>W C000 CB00 9000
                V C000 CB00 9000 9000 9813
            </code>
        </p>

        <h3>Beispiel zu den Basic-Erweiterungen</h3>

        <p>Laden Sie Hypra-Ass, starten Sie ihn und laden anschließend den Reassembler. Geben Sie NEW und danach im Direktmodus
            <code>SYS 49152,$1000,$1FD7:←E 64 &lt;RETURN&gt;</code>
            ein. Der Reassembler bekommt durch den SYS-Befehl die Start- und Endadresse des Maschinenprogramms mitgeteilt. Der »E«-Befehl setzt Bit 6 des Informations-Bytes und startet den Reassembler. Das gesetzte Bit 6 bewirkt, daß kein Quelltext, sondern ein Informationsprogramm erstellt wird. LISTen Sie das Programm mit /E. Sie sehen eine Reihe von »T«-Befehlen und zum Schluß einen »E«-Befehl. Schreiben Sie hinter diesen Befehl die Zahl 32, drücken die RETURN-Taste und geben folgende Zeile im Direktmodus ein:
            <code>OPEN 1,8,1,"REASS DEMO,P,W":CMD 1:SYS 49152,$1000,$1FD7:GOTO 100 &lt;RETURN&gt;</code>
        </p>

        <p>Mit dem OPEN-Befehl wird ein Programmfile mit dem Namen »REASS DEMO« zum Schreiben geöffnet. Der nachfolgende CMD-Befehl leitet die Ausgabe des Quelltextes auf dieses File um. Durch den SYS-Befehl wird dem Reassembler die Start- und Endadresse des Maschinenprogramms mitgeteilt. Der GOTO-Befehl startet schließlich das Informationsprogramm (der RUN-Befehl darf dazu nicht benutzt werden, da er das geöffnete File schließen würde). Die »T«-Befehle im Informationsprogramm werden ausgeführt, bis der »E«-Befehl Bit 5 setzt und den Reassembler startet. Das gesetzte fünfte Bit bewirkt, daß externe Label und Tabellenlabel speziell gekennzeichnet werden.</p>

        <p>Das so auf Diskette erzeugte Programmfile kann mit LOAD ’’REASS DEMO",8 geladen, geLISTet, editiert und assembliert werden.</p>

        <address class="author">(Martin Wehner/ah)</address>

        <figure>
            <pre data-filename="reass.prg" data-name="Reassembler" data-mse=mse1></pre>
            <figcaption>Listing zum »Reassembler«. Bitte beachten Sie die Eingabehinweise auf Seite 54.</figcaption>
        </figure>
        <div class="binary_download" data-filename="reass.prg" data-name="Reassembler"></div>
    </article>
</body>

</html>